import pyaudio
import numpy as np
import librosa
import RPi.GPIO as GPIO
import time

RED_PIN = 17
GREEN_PIN = 27
BLUE_PIN = 22
YELLOW_PIN = 23
WHITE_PIN = 24

GPIO.setmode(GPIO.BCM)
GPIO.setup(RED_PIN, GPIO.OUT)
GPIO.setup(GREEN_PIN, GPIO.OUT)
GPIO.setup(BLUE_PIN, GPIO.OUT)
GPIO.setup(YELLOW_PIN, GPIO.OUT)
GPIO.setup(WHITE_PIN, GPIO.OUT)

pwm_red = GPIO.PWM(RED_PIN, 100)
pwm_green = GPIO.PWM(GREEN_PIN, 100)
pwm_blue = GPIO.PWM(BLUE_PIN, 100)
pwm_yellow = GPIO.PWM(YELLOW_PIN, 100)
pwm_white = GPIO.PWM(WHITE_PIN, 100)

pwm_red.start(0)
pwm_green.start(0)
pwm_blue.start(0)
pwm_yellow.start(0)
pwm_white.start(0)

FORMAT = pyaudio.paInt16 
CHANNELS = 1 
RATE = 44100 
CHUNK = 1024

audio = pyaudio.PyAudio()
stream = audio.open(format=FORMAT, channels=CHANNELS,
                    rate=RATE, input=True, frames_per_buffer=CHUNK)

def get_bpm(y, sr):
    onset_env = librosa.onset.onset_strength(y=y, sr=sr)
    bpm, _ = librosa.beat.beat_track(onset_envelope=onset_env, sr=sr)
    return int(bpm) 

try:
    while True:
        data = stream.read(CHUNK, exception_on_overflow=False)
        audio_data = np.frombuffer(data, dtype=np.int16)

        fft_result = np.abs(np.fft.rfft(audio_data))
        freqs = np.fft.rfftfreq(len(audio_data), 1.0 / RATE)
        dominant_freq = freqs[np.argmax(fft_result)]  # ê°€ì¥ ê°•í•œ ì£¼íŒŒìˆ˜ ì°¾ê¸°

        # ğŸµ BPM ë¶„ì„ (Librosa)
        y = audio_data.astype(float) / np.max(audio_data)  # Normalize
        bpm = get_bpm(y, RATE)  # BPM ì¸¡ì •
        print(f"Detected BPM: {bpm}")

        # ğŸ”¥ LED ë°˜ì‘ ì„¤ì •
        if bpm <= 90:  # ëŠë¦° BPM â†’ ì´ˆë¡, íŒŒë‘, í°ìƒ‰ í™œì„±í™”
            pwm_red.ChangeDutyCycle(0)    # ë¹¨ê°• OFF
            pwm_yellow.ChangeDutyCycle(0)  # ë…¸ë‘ OFF
            
            pwm_green.ChangeDutyCycle(50)  # ì´ˆë¡ ON
            pwm_blue.ChangeDutyCycle(50)   # íŒŒë‘ ON
            pwm_white.ChangeDutyCycle(50)  # í°ìƒ‰ ON

        elif bpm >= 120:  # ë¹ ë¥¸ BPM â†’ í°ìƒ‰, ë¹¨ê°•, ë…¸ë‘ í™œì„±í™”
            pwm_green.ChangeDutyCycle(0)  # ì´ˆë¡ OFF
            pwm_blue.ChangeDutyCycle(0)   # íŒŒë‘ OFF
            
            pwm_red.ChangeDutyCycle(80)   # ë¹¨ê°• ON
            pwm_yellow.ChangeDutyCycle(80) # ë…¸ë‘ ON
            pwm_white.ChangeDutyCycle(80) # í°ìƒ‰ ON
            
        else:  # ì¤‘ê°„ BPM (90~120) â†’ ëª¨ë“  LED ì ë‹¹íˆ ë°ê²Œ
            pwm_red.ChangeDutyCycle(30)
            pwm_yellow.ChangeDutyCycle(30)
            pwm_green.ChangeDutyCycle(30)
            pwm_blue.ChangeDutyCycle(30)
            pwm_white.ChangeDutyCycle(50)

        time.sleep(0.5)  # ì¼ì • ì‹œê°„ ê°„ê²©ìœ¼ë¡œ ë¶„ì„

except KeyboardInterrupt:
    print("í”„ë¡œê·¸ë¨ ì¢…ë£Œ...")

finally:
    # ëª¨ë“  PWM ë° GPIO ì •ë¦¬
    pwm_red.stop()
    pwm_green.stop()
    pwm_blue.stop()
    pwm_yellow.stop()
    pwm_white.stop()
    GPIO.cleanup()
    stream.stop_stream()
    stream.close()
    audio.terminate()
